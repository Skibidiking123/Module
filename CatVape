local loadonscreen = not game:IsLoaded()

repeat
	task.wait()
until game:IsLoaded()

if loadonscreen then
    task.wait(4)
end

if shared.vape then
	shared.vape:Uninject()
end

local license = ({...})[1] or {}
local developer = license.Developer or getgenv().catvapedev or false
local closet = true
local commit = 'main'

local loadstring = function(...)
	local res, err = loadstring(...)
	if err then
		error(err)
	end
	return res
end

local cloneref = cloneref or function(ref) return ref end
local gethui = gethui or function() return game:GetService('Players').LocalPlayer.PlayerGui end

local canDebug = debug.getupvalue ~= nil

local function downloadFile(path, func)
	if not isfile(path) then
		local suc, res = pcall(function()
			local subbed = path:gsub('catrewrite/', '')
			subbed = subbed:gsub(' ', '%%20')
			return game:HttpGet('https://raw.githubusercontent.com/new-qwertyui/CatV5/'..commit..'/'..subbed, true)
		end)
		if not suc or res == '404: Not Found' then
			error(res)
		end
		writefile(path, res)
	end
	return (func or readfile)(path)
end

for _, folder in {'catrewrite', 'catrewrite/communication', 'catrewrite/translations', 'catrewrite/games', 'catrewrite/cache', 'catrewrite/games/bedwars', 'catrewrite/profiles', 'catrewrite/assets', 'catrewrite/libraries', 'catrewrite/libraries/Enviroments', 'catrewrite/guis', 'catrewrite/libraries/Weather', 'catrewrite/libraries/LightningLib', 'catrewrite/libraries/LightningLib/Sparks'} do
	if not isfolder(folder) then
		makefolder(folder)
	end
end

pcall(downloadFile, 'catrewrite/libraries/pathfind.lua')
pcall(downloadFile, 'catrewrite/init.lua')
pcall(downloadFile, 'catrewrite/libraries/oldpath.lua')

shared.VapeDeveloper = developer
getgenv().used_init = true
getgenv().catvapedev = developer
getgenv().closet = closet
getgenv().canDebug = canDebug

getgenv().username = license.Username or getgenv().username
getgenv().password = license.Password or getgenv().password

local success, err = pcall(function()
	loadstring(downloadFile('catrewrite/main.lua'), 'main')()
end)

if not success then
	error('Failed to initalize catvape: '.. err, 8)
elseif not closet then
	loadstring(downloadFile('catrewrite/libraries/annc.lua'), 'announcements.lua')() 
end
